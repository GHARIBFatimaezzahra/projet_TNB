<div class="dashboard-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <h2>GeoTNB</h2>
      <p>Commune d'Oujda</p>
    </div>
    <ul class="nav-menu">
      <li class="nav-item">
        <a href="#" class="nav-link active">
          <span class="nav-icon">📊</span>
          Dashboard
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link">
          <span class="nav-icon">🗺️</span>
          Cartographie
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link">
          <span class="nav-icon">🏘️</span>
          Parcelles
        </a>
      </li>
      <li class="nav-item">
        <a href="/spatial-queries" class="nav-link">
          <span class="nav-icon">🔍</span>
          Recherche Avancée
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link">
          <span class="nav-icon">👥</span>
          Propriétaires
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link">
          <span class="nav-icon">📋</span>
          Fiches TNB
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link">
          <span class="nav-icon">⚙️</span>
          Paramètres
        </a>
      </li>
    </ul>
  </aside>

  <!-- Contenu principal -->
  <main class="main-content">
    <!-- En-tête -->
    <header class="header">
      <h1>Tableau de Bord TNB</h1>
      <p>Vue d'ensemble des terrains non bâtis - Mise à jour en temps réel</p>
    </header>

    <!-- Filtres -->
    <section class="filters-section">
      <h3 style="margin-bottom: 20px; color: #333;">🔍 Filtres et Sélections</h3>
      <div class="filters-grid">
        <div class="control-group">
          <label class="control-label">Secteur</label>
          <select class="control-input" [(ngModel)]="selectedSecteur">
            <option value="">Tous les secteurs</option>
            <option value="centre">Centre-ville</option>
            <option value="hay-al-qods">Hay Al Qods</option>
            <option value="sidi-maafa">Sidi Maâfa</option>
            <option value="al-andalous">Al Andalous</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Zonage</label>
          <select class="control-input" [(ngModel)]="selectedZonage">
            <option value="">Tous les zonages</option>
            <option value="r+2">Zone R+2</option>
            <option value="r+4">Zone R+4</option>
            <option value="industriel">Zone Industrielle</option>
            <option value="villas">Zone Villas</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Statut Foncier</label>
          <select class="control-input" [(ngModel)]="selectedStatut">
            <option value="">Tous les statuts</option>
            <option value="tf">Titre Foncier (TF)</option>
            <option value="r">Réquisition (R)</option>
            <option value="ni">Non Immatriculé (NI)</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">État d'occupation</label>
          <select class="control-input" [(ngModel)]="selectedOccupation">
            <option value="">Tous les états</option>
            <option value="nu">Terrain nu</option>
            <option value="partiel">Partiellement construit</option>
            <option value="construction">En cours de construction</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Indicateurs clés -->
    <section class="stats-grid">
      <div class="stat-card pulse">
        <div class="stat-value animate-number">{{ kpiData?.terrainsRecenses | number }}</div>
        <div class="stat-label">Terrains recensés</div>
        <div class="stat-trend">↗️ +5.2% ce mois</div>
      </div>
      <div class="stat-card">
        <div class="stat-value animate-number">{{ kpiData?.terrainsImposables | number }}</div>
        <div class="stat-label">Terrains imposables</div>
        <div class="stat-trend">📈 {{ tauxImposition | percent:'1.1-1' }} du total</div>
      </div>
      <div class="stat-card">
        <div class="stat-value animate-number">{{ kpiData?.superficieTotale | number:'1.0-0' }} ha</div>
        <div class="stat-label">Superficie totale</div>
        <div class="stat-trend">🏘️ Périmètre urbain</div>
      </div>
      <div class="stat-card">
        <div class="stat-value animate-number">{{ kpiData?.surfaceImposable | number:'1.0-0' }} ha</div>
        <div class="stat-label">Surface imposable</div>
        <div class="stat-trend">💰 {{ tauxSurfaceImposable | percent:'1.1-1' }} taxable</div>
      </div>
      <div class="stat-card">
        <div class="stat-value animate-number">{{ kpiData?.rendementPrevisionnel | number:'1.1-1' }} MDH</div>
        <div class="stat-label">Rendement prévisionnel</div>
        <div class="stat-trend">💸 Recette annuelle</div>
      </div>
      <div class="stat-card">
        <div class="stat-value animate-number">{{ kpiData?.tauxAssujettissement | percent:'1.1-1' }}</div>
        <div class="stat-label">Taux d'assujettissement</div>
        <div class="stat-trend">⚖️ Base imposable</div>
      </div>
    </section>

    <!-- Graphiques -->
    <section class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">
          <span>📊 Répartition par Statut Foncier</span>
          <button class="btn btn-secondary" (click)="exportChart('statut')">Export</button>
        </div>
        <div class="chart-container">
          <canvas id="statutChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-title">
          <span>📈 Évolution Mensuelle des Recettes</span>
          <button class="btn btn-secondary" (click)="exportChart('recettes')">Export</button>
        </div>
        <div class="chart-container">
          <canvas id="recettesChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-title">
          <span>🏘️ Répartition par Zonage Urbanistique</span>
          <button class="btn btn-secondary" (click)="exportChart('zonage')">Export</button>
        </div>
        <div class="chart-container">
          <canvas id="zonageChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-title">
          <span>💰 Tranches Tarifaires</span>
          <button class="btn btn-secondary" (click)="exportChart('tarifs')">Export</button>
        </div>
        <div class="chart-container">
          <canvas id="tarifsChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Section Cartes Thématiques -->
    <section class="thematic-maps-section">
        <!-- En-tête avec titre et informations -->
        <div class="section-header">
            <h2 class="section-title">🗺️ Cartes Thématiques TNB</h2>
            <p class="section-subtitle">Visualisation géographique des parcelles par statut foncier et zonage urbanistique</p>
            <div class="map-info">
                <span class="info-item">📅 Dernière mise à jour : {{ lastUpdateDate | date:'dd/MM/yyyy' }}</span>
                <span class="info-item">📍 Projection : EPSG:26191 (Merchich/Nord Maroc)</span>
                <span class="info-item">📊 Source : Base de données TNB</span>
            </div>
        </div>

        <!-- Contrôles des cartes thématiques -->
        <div class="map-controls">
            <!-- Sélecteur de thème -->
            <div class="theme-selector">
                <button 
                    class="theme-btn" 
                    [class.active]="selectedTheme === 'status'"
                    (click)="switchTheme('status')">
                    <i class="fas fa-certificate"></i>
                    Statut Foncier
                </button>
                <button 
                    class="theme-btn" 
                    [class.active]="selectedTheme === 'zoning'"
                    (click)="switchTheme('zoning')">
                    <i class="fas fa-city"></i>
                    Zonage Urbanistique
                </button>
            </div>
            
            <!-- Légende interactive -->
            <div class="map-legend">
                <h4>🎨 Légende</h4>
                <div class="legend-items" [ngSwitch]="selectedTheme">
                    <!-- Légende Statut Foncier -->
                    <div *ngSwitchCase="'status'" class="legend-status">
                        <div class="legend-item" (click)="toggleLegendItem('TF')" [class.disabled]="!isLegendItemActive('TF')">
                            <span class="legend-color status-tf"></span>
                            <span class="legend-label">Titre Foncier (TF)</span>
                            <span class="legend-count">{{ getLegendCount('TF') }}</span>
                        </div>
                        <div class="legend-item" (click)="toggleLegendItem('R')" [class.disabled]="!isLegendItemActive('R')">
                            <span class="legend-color status-r"></span>
                            <span class="legend-label">Réquisition (R)</span>
                            <span class="legend-count">{{ getLegendCount('R') }}</span>
                        </div>
                        <div class="legend-item" (click)="toggleLegendItem('NI')" [class.disabled]="!isLegendItemActive('NI')">
                            <span class="legend-color status-ni"></span>
                            <span class="legend-label">Non Immatriculé (NI)</span>
                            <span class="legend-count">{{ getLegendCount('NI') }}</span>
                        </div>
                    </div>
                    
                    <!-- Légende Zonage Urbanistique -->
                    <div *ngSwitchCase="'zoning'" class="legend-zoning">
                        <div class="legend-item" (click)="toggleLegendItem('R+2')" [class.disabled]="!isLegendItemActive('R+2')">
                            <span class="legend-color zone-r2"></span>
                            <span class="legend-label">Zone R+2</span>
                            <span class="legend-count">{{ getLegendCount('R+2') }}</span>
                        </div>
                        <div class="legend-item" (click)="toggleLegendItem('R+4')" [class.disabled]="!isLegendItemActive('R+4')">
                            <span class="legend-color zone-r4"></span>
                            <span class="legend-label">Zone R+4</span>
                            <span class="legend-count">{{ getLegendCount('R+4') }}</span>
                        </div>
                        <div class="legend-item" (click)="toggleLegendItem('Villas')" [class.disabled]="!isLegendItemActive('Villas')">
                            <span class="legend-color zone-villas"></span>
                            <span class="legend-label">Zone Villas</span>
                            <span class="legend-count">{{ getLegendCount('Villas') }}</span>
                        </div>
                        <div class="legend-item" (click)="toggleLegendItem('Industriel')" [class.disabled]="!isLegendItemActive('Industriel')">
                            <span class="legend-color zone-industriel"></span>
                            <span class="legend-label">Zone Industrielle</span>
                            <span class="legend-count">{{ getLegendCount('Industriel') }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Couches disponibles -->
            <div class="layers-control">
                <h4>🗂️ Couches Disponibles</h4>
                <div class="layer-item">
                    <input type="checkbox" id="parcelles-layer" checked (change)="toggleLayer('parcelles', $event)">
                    <label for="parcelles-layer">Parcelles TNB</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="communes-layer" checked (change)="toggleLayer('communes', $event)">
                    <label for="communes-layer">Limites Communales</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="voirie-layer" (change)="toggleLayer('voirie', $event)">
                    <label for="voirie-layer">Réseau Voirie</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="hotels-layer" (change)="toggleLayer('hotels', $event)">
                    <label for="hotels-layer">Hôtels</label>
                </div>
            </div>
        </div>

        <!-- Carte Thématique Interactive -->
        <div class="thematic-map-container">
            <div class="map-header">
                <h3>{{ selectedTheme === 'status' ? 'Carte de Répartition par Statut Foncier' : 'Carte de Zonage Urbanistique' }}</h3>
                <div class="map-tools">
                    <button class="map-tool-btn" (click)="zoomIn()" title="Zoom avant">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="map-tool-btn" (click)="zoomOut()" title="Zoom arrière">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="map-tool-btn" (click)="zoomToExtent()" title="Vue d'ensemble">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                    <button class="map-tool-btn" (click)="toggleFullscreen()" title="Plein écran">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            
            <app-map
                mapId="thematic-map"
                [options]="thematicMapOptions"
                [parcelles]="filteredParcelles"
                [showControls]="true"
                [showLayers]="true"
                [enableSelection]="true"
                [enableDrawing]="false"
                (parcelleSelected)="onParcelleSelected($event)"
                (mapReady)="onThematicMapReady($event)">
            </app-map>
            
            <!-- Indicateurs de la carte -->
            <div class="map-indicators">
                <div class="coordinates-display" id="coordinates">
                    X: -7.611400 | Y: 33.573100
                </div>
                <div class="scale-display" id="scale">
                    1:50,000
                </div>
                <div class="north-indicator">
                    <i class="fas fa-arrow-up"></i> N
                </div>
            </div>
        </div>

        <!-- Statistiques et informations -->
        <div class="map-stats" *ngIf="thematicStats">
            <h4>📊 Statistiques par Catégorie</h4>
            <div class="stats-grid">
                <div class="stat-card" *ngFor="let stat of thematicStats" [style.border-left-color]="stat.color">
                    <div class="stat-value">{{ stat.count }}</div>
                    <div class="stat-label">{{ stat.label }}</div>
                    <div class="stat-percentage">{{ stat.percentage }}%</div>
                    <div class="stat-trend" *ngIf="stat.trend">
                        <i class="fas" [class.fa-arrow-up]="stat.trend > 0" [class.fa-arrow-down]="stat.trend < 0"></i>
                        {{ stat.trend }}%
                    </div>
                </div>
            </div>
        </div>

        <!-- Exports et rapports -->
        <div class="export-section">
            <h4>📤 Exports et Rapports</h4>
            <div class="export-buttons">
                <button class="export-btn primary" (click)="exportMap('pdf')">
                    <i class="fas fa-file-pdf"></i>
                    Rapport PDF Complet
                </button>
                <button class="export-btn" (click)="exportMap('excel')">
                    <i class="fas fa-file-excel"></i>
                    Données Excel
                </button>
                <button class="export-btn" (click)="exportMap('image')">
                    <i class="fas fa-image"></i>
                    Image PNG
                </button>
                <button class="export-btn" (click)="exportMap('geopackage')">
                    <i class="fas fa-map"></i>
                    GeoPackage
                </button>
            </div>
        </div>
    </section>

    <!-- Section d'export -->
    <section class="export-section">
      <h3 style="margin-bottom: 20px; color: #333;">📤 Exports et Rapports</h3>
      <div class="export-buttons">
        <button class="btn btn-primary" (click)="exportReport('pdf')">
          📊 Rapport PDF Complet
        </button>
        <button class="btn btn-primary" (click)="exportReport('excel')">
          📈 Graphiques Excel
        </button>
        <button class="btn btn-secondary" (click)="exportReport('cartes')">
          🗺️ Cartes Thématiques
        </button>
        <button class="btn btn-secondary" (click)="exportReport('donnees')">
          📋 Données Tabulaires
        </button>
        <button class="btn btn-secondary" (click)="exportReport('secteurs')">
          🏘️ Fiches par Secteur
        </button>
      </div>
    </section>
  </main>
</div>
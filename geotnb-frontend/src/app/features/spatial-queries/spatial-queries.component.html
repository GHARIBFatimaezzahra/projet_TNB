<div class="container">
  <div class="header">
    <h1>üîç Requ√™tes Spatiales TNB</h1>
    <p>Recherche et analyse g√©ographique des parcelles non b√¢ties - Syst√®me d'Information G√©ographique</p>
  </div>

  <div class="main-content">
    <div class="sidebar">
      <div class="query-section">
        <h3 class="section-title">üéØ Type de Requ√™te</h3>
        <div class="query-tabs">
          <button class="tab-btn" [class.active]="currentTab === 'emprise'" (click)="switchTab('emprise')">Emprise</button>
          <button class="tab-btn" [class.active]="currentTab === 'secteur'" (click)="switchTab('secteur')">Secteur</button>
          <button class="tab-btn" [class.active]="currentTab === 'distance'" (click)="switchTab('distance')">Distance</button>
        </div>

        <!-- Onglet Emprise -->
        <div class="tab-content" [class.active]="currentTab === 'emprise'">
          <div class="form-group">
            <label class="form-label">Mode de d√©finition</label>
            <div class="draw-tools">
              <button class="draw-btn" [class.active]="currentDrawMode === 'polygon'" (click)="setDrawMode('polygon')">
                üìê Polygone
              </button>
              <button class="draw-btn" [class.active]="currentDrawMode === 'rectangle'" (click)="setDrawMode('rectangle')">
                ‚¨õ Rectangle
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Filtres optionnels</label>
            <div class="filters-grid">
              <div class="filter-item">
                <label>Statut Foncier</label>
                <select class="form-select" [(ngModel)]="filters.statutFoncier" name="statutFoncier">
                  <option value="">Tous les statuts</option>
                  <option *ngFor="let statut of statutFoncierOptions" [value]="statut.value">{{ statut.label }}</option>
                </select>
              </div>
              <div class="filter-item">
                <label>Zonage Urbanistique</label>
                <select class="form-select" [(ngModel)]="filters.zonage" name="zonage">
                  <option value="">Tous les zonages</option>
                  <option *ngFor="let zonage of zonageOptions" [value]="zonage.value">{{ zonage.label }}</option>
                </select>
              </div>
              <div class="filter-item">
                <label>Surface min. (m¬≤)</label>
                <input type="number" class="form-input" [(ngModel)]="filters.surfaceMin" name="surfaceMin" placeholder="0">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Coordonn√©es manuelles (optionnel)</label>
            <div class="coord-inputs">
              <input type="number" class="form-input" placeholder="X min" [(ngModel)]="coordinates.xMin" name="xMin">
              <input type="number" class="form-input" placeholder="Y min" [(ngModel)]="coordinates.yMin" name="yMin">
              <input type="number" class="form-input" placeholder="X max" [(ngModel)]="coordinates.xMax" name="xMax">
              <input type="number" class="form-input" placeholder="Y max" [(ngModel)]="coordinates.yMax" name="yMax">
            </div>
          </div>
          
          <div class="form-group" *ngIf="currentDrawing">
            <div class="drawing-info">
              <h4>üéØ Zone dessin√©e</h4>
              <p>Cliquez sur "Rechercher" pour trouver les parcelles dans cette zone</p>
              <button class="btn btn-success" (click)="executeIntersectionQuery()" [disabled]="isLoadingQuery">
                <i class="fas fa-search"></i>
                {{ isLoadingQuery ? 'Recherche...' : 'Rechercher dans cette zone' }}
              </button>
            </div>
          </div>
        </div>

        <!-- Onglet Secteur -->
        <div class="tab-content" [class.active]="currentTab === 'secteur'">
          <div class="form-group">
            <label class="form-label">Commune</label>
            <select class="form-select" [(ngModel)]="selectedCommune" name="commune">
              <option value="">S√©lectionner une commune...</option>
              <option *ngFor="let commune of communes" [value]="commune.id">{{ commune.nom }}</option>
            </select>
          </div>
          
          <div class="form-group">
            <button class="btn btn-primary" (click)="executeSectorQuery()" [disabled]="!selectedCommune || isLoadingQuery">
              <i class="fas fa-search"></i>
              {{ isLoadingQuery ? 'Recherche...' : 'Rechercher par commune' }}
            </button>
          </div>
        </div>

        <!-- Onglet Distance -->
        <div class="tab-content" [class.active]="currentTab === 'distance'">
          <div class="form-group">
            <label class="form-label">Type de recherche par distance</label>
            <div class="distance-options">
              <button class="btn btn-secondary" (click)="switchTab('hotel')">
                <i class="fas fa-hotel"></i>
                Pr√®s d'un h√¥tel
              </button>
              <button class="btn btn-secondary" (click)="switchTab('road')">
                <i class="fas fa-road"></i>
                Le long d'une voie
              </button>
              <button class="btn btn-secondary" (click)="switchTab('point')">
                <i class="fas fa-map-marker-alt"></i>
                Point personnalis√©
              </button>
            </div>
          </div>
        </div>

        <!-- Onglet H√¥tel -->
        <div class="tab-content" [class.active]="currentTab === 'hotel'">
          <div class="form-group">
            <label class="form-label">H√¥tel de r√©f√©rence</label>
            <select class="form-select" [(ngModel)]="selectedHotel" name="hotel">
              <option value="">S√©lectionner un h√¥tel...</option>
              <option *ngFor="let hotel of hotels" [value]="hotel.id">{{ hotel.nom }}</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Rayon de recherche</label>
            <input type="range" class="distance-slider" min="100" max="5000" [(ngModel)]="bufferRadius" name="bufferRadius">
            <div class="slider-value">{{ bufferRadius >= 1000 ? (bufferRadius / 1000).toFixed(1) + ' km' : bufferRadius + ' m√®tres' }}</div>
          </div>
          
          <div class="form-group">
            <button class="btn btn-primary" (click)="executeHotelBufferQuery()" [disabled]="!selectedHotel || isLoadingQuery">
              <i class="fas fa-search"></i>
              {{ isLoadingQuery ? 'Recherche...' : 'Rechercher pr√®s de l\'h√¥tel' }}
            </button>
          </div>
        </div>

        <!-- Onglet Voie -->
        <div class="tab-content" [class.active]="currentTab === 'road'">
          <div class="form-group">
            <label class="form-label">Voie de r√©f√©rence</label>
            <select class="form-select" [(ngModel)]="selectedRoad" name="road">
              <option value="">S√©lectionner une voie...</option>
              <option *ngFor="let road of roads" [value]="road.id">{{ road.nom }}</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Distance de la voie</label>
            <input type="range" class="distance-slider" min="10" max="500" [(ngModel)]="roadBuffer" name="roadBuffer">
            <div class="slider-value">{{ roadBuffer }} m√®tres</div>
          </div>
          
          <div class="form-group">
            <button class="btn btn-primary" (click)="executeRoadBufferQuery()" [disabled]="!selectedRoad || isLoadingQuery">
              <i class="fas fa-search"></i>
              {{ isLoadingQuery ? 'Recherche...' : 'Rechercher le long de la voie' }}
            </button>
          </div>
        </div>

        <!-- Onglet Point personnalis√© -->
        <div class="tab-content" [class.active]="currentTab === 'point'">
          <div class="form-group">
            <label class="form-label">Point de r√©f√©rence</label>
            <div class="draw-tools">
              <button class="draw-btn" [class.active]="currentPointMode === 'click'" (click)="setPointMode('click')">
                üìç Clic carte
              </button>
              <button class="draw-btn" [class.active]="currentPointMode === 'coords'" (click)="setPointMode('coords')">
                üéØ Coordonn√©es
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Rayon de recherche</label>
            <input type="range" class="distance-slider" min="50" max="5000" [(ngModel)]="bufferRadius" name="bufferRadius">
            <div class="slider-value">{{ bufferRadius >= 1000 ? (bufferRadius / 1000).toFixed(1) + ' km' : bufferRadius + ' m√®tres' }}</div>
          </div>
        </div>
      </div>

      <div class="query-section">
        <h3 class="section-title">üîß Filtres Additionnels</h3>
        
        <div class="form-group">
          <label class="form-label">Statut foncier</label>
          <select class="form-select" [(ngModel)]="filters.statutFoncier" name="statutFoncier">
            <option value="">Tous</option>
            <option value="tf">Titre Foncier (TF)</option>
            <option value="r">R√©quisition (R)</option>
            <option value="ni">Non Immatricul√© (NI)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Zonage urbanistique</label>
          <select class="form-select" [(ngModel)]="filters.zonage" name="zonage">
            <option value="">Tous</option>
            <option value="r2">Zone R+2</option>
            <option value="r4">Zone R+4</option>
            <option value="villas">Zone Villas</option>
            <option value="industriel">Zone Industrielle</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Surface minimale (m¬≤)</label>
          <input type="number" class="form-input" placeholder="Ex: 100" [(ngModel)]="filters.surfaceMin" name="surfaceMin">
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" (click)="executeQuery()" [disabled]="isLoading">
          üîç Lancer la requ√™te
        </button>
        <button class="btn btn-secondary" (click)="clearQuery()" [disabled]="isLoading">
          üóëÔ∏è Effacer
        </button>
      </div>
    </div>

    <div class="results-panel">
      <div class="results-header">
        <div class="results-title">
          üìä R√©sultats de recherche
          <span class="results-count">{{ resultsCount }}</span>
        </div>
        <div class="export-buttons" *ngIf="hasResults">
          <button class="btn-export" (click)="exportResults('excel')">üìä Excel</button>
          <button class="btn-export" (click)="exportResults('csv')">üìã CSV</button>
          <button class="btn-export" (click)="exportResults('gpkg')">üó∫Ô∏è GeoPackage</button>
          <button class="btn-export" (click)="exportResults('pdf')">üìÑ PDF Carte</button>
        </div>
      </div>

      <!-- Statistiques des requ√™tes spatiales -->
      <div class="query-statistics" *ngIf="queryStatistics">
        <h3 class="section-title">üìä Statistiques de la Requ√™te</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">{{ queryStatistics.totalParcelles }}</div>
            <div class="stat-label">Parcelles trouv√©es</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ (queryStatistics.totalSurface / 10000).toFixed(2) }}</div>
            <div class="stat-label">Surface totale (ha)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ (queryStatistics.surfaceMoyenne / 10000).toFixed(2) }}</div>
            <div class="stat-label">Surface moyenne (ha)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ queryStatistics.executionTime }}ms</div>
            <div class="stat-label">Temps d'ex√©cution</div>
          </div>
        </div>
        
        <!-- R√©partition par statut -->
        <div class="distribution-section" *ngIf="queryStatistics.parcellesParStatut">
          <h4>R√©partition par Statut Foncier</h4>
          <div class="distribution-chart">
            <div class="distribution-item" *ngFor="let statut of getStatutDistribution()">
              <div class="distribution-bar" [style.width.%]="statut.percentage"></div>
              <span class="distribution-label">{{ statut.label }} ({{ statut.count }})</span>
            </div>
          </div>
        </div>
        
        <!-- R√©partition par zonage -->
        <div class="distribution-section" *ngIf="queryStatistics.parcellesParZonage">
          <h4>R√©partition par Zonage</h4>
          <div class="distribution-chart">
            <div class="distribution-item" *ngFor="let zonage of getZonageDistribution()">
              <div class="distribution-bar" [style.width.%]="zonage.percentage"></div>
              <span class="distribution-label">{{ zonage.label }} ({{ zonage.count }})</span>
            </div>
          </div>
        </div>
      </div>

      <div class="summary-cards" *ngIf="hasResults">
        <div class="summary-card">
          <div class="summary-value">{{ summary.totalParcelles }}</div>
          <div class="summary-label">Parcelles trouv√©es</div>
        </div>
        <div class="summary-card">
          <div class="summary-value">{{ (summary.surfaceTotale / 10000).toFixed(2) }}</div>
          <div class="summary-label">Surface totale (ha)</div>
        </div>
        <div class="summary-card">
          <div class="summary-value">{{ (summary.surfaceImposable / 10000).toFixed(2) }}</div>
          <div class="summary-label">Surface imposable (ha)</div>
        </div>
        <div class="summary-card">
          <div class="summary-value">{{ summary.recettePrevue | number }}</div>
          <div class="summary-label">Recette pr√©vue (DH)</div>
        </div>
      </div>

      <div class="map-container">
        <!-- Carte interactive avec les m√™mes couches que la cr√©ation de parcelle -->
        <app-map
          mapId="spatial-queries-map"
          [options]="mapOptions"
          [parcelles]="[]"
          [showControls]="true"
          [showLayers]="true"
          [enableSelection]="false"
          [enableDrawing]="true"
          (geometryDrawn)="onGeometryDrawn($event)"
          (mapReady)="onMapReady($event)">
        </app-map>
        
        <!-- Instructions de dessin -->
        <div class="drawing-instructions" [class.show]="currentTab === 'emprise' && isDrawing">
          Cliquez sur la carte pour dessiner votre zone de recherche
        </div>
        
        <!-- Indicateur de chargement -->
        <div class="loading" [class.show]="isLoading">
          <div class="spinner"></div>
          <div class="loading-text">Recherche en cours...</div>
        </div>
      </div>

      <div class="results-table">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>R√©f√©rence</th>
                <th>Propri√©taire</th>
                <th>Statut</th>
                <th>Surface (m¬≤)</th>
                <th>Zone</th>
                <th>Montant TNB</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="!hasResults">
                <td colspan="7" class="no-results">
                  Aucune requ√™te lanc√©e - Utilisez les outils de recherche ci-dessus
                </td>
              </tr>
              <tr *ngFor="let parcelle of spatialQueryResults?.parcelles || []">
                <td><strong>{{ parcelle.referenceFonciere }}</strong></td>
                <td>{{ parcelle.proprietaire || 'N/A' }}</td>
                <td><span class="status-badge" [class]="'status-' + parcelle.statutFoncier?.toLowerCase()">{{ parcelle.statutFoncier }}</span></td>
                <td>{{ parcelle.surfaceTotale | number }}</td>
                <td>{{ parcelle.zoneUrbanistique }}</td>
                <td><strong>{{ parcelle.montantTotalTnb | number }} DH</strong></td>
                <td>
                  <button class="btn-export" (click)="viewParcel(parcelle.referenceFonciere)">üëÅÔ∏è Voir</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
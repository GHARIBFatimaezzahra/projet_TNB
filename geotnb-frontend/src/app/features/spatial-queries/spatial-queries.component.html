<div class="container">
  <div class="header">
    <h1>🔍 Requêtes Spatiales TNB</h1>
    <p>Recherche et analyse géographique des parcelles non bâties - Système d'Information Géographique</p>
  </div>

  <div class="main-content">
    <div class="sidebar">
      <div class="query-section">
        <h3 class="section-title">🎯 Type de Requête</h3>
        <div class="query-tabs">
          <button class="tab-btn" [class.active]="currentTab === 'emprise'" (click)="switchTab('emprise')">Emprise</button>
          <button class="tab-btn" [class.active]="currentTab === 'secteur'" (click)="switchTab('secteur')">Secteur</button>
          <button class="tab-btn" [class.active]="currentTab === 'distance'" (click)="switchTab('distance')">Distance</button>
        </div>

        <!-- Onglet Emprise - Intersection avec une emprise -->
        <div class="tab-content" [class.active]="currentTab === 'emprise'">
          <div class="query-info">
            <h4>🔍 Intersection avec une Emprise</h4>
            <p>Dessinez une zone géographique pour trouver toutes les parcelles qui la coupent (même partiellement).</p>
            <div class="usage-example">
              <strong>Usage :</strong> Savoir combien de terrains non bâtis se trouvent dans une zone d'aménagement.
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Mode de définition</label>
            <div class="draw-tools">
              <button class="draw-btn" [class.active]="currentDrawMode === 'polygon'" (click)="setDrawMode('polygon')">
                📐 Polygone
              </button>
              <button class="draw-btn" [class.active]="currentDrawMode === 'rectangle'" (click)="setDrawMode('rectangle')">
                ⬛ Rectangle
              </button>
              <button class="draw-btn" [class.active]="currentDrawMode === 'circle'" (click)="setDrawMode('circle')">
                ⭕ Cercle
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Coordonnées manuelles (optionnel)</label>
            <div class="coord-inputs">
              <input type="number" class="form-input" placeholder="X min" [(ngModel)]="coordinates.xMin" name="xMin">
              <input type="number" class="form-input" placeholder="Y min" [(ngModel)]="coordinates.yMin" name="yMin">
              <input type="number" class="form-input" placeholder="X max" [(ngModel)]="coordinates.xMax" name="xMax">
              <input type="number" class="form-input" placeholder="Y max" [(ngModel)]="coordinates.yMax" name="yMax">
            </div>
          </div>

          <div class="form-group" *ngIf="currentDrawMode === 'circle'">
            <label class="form-label">Rayon (mètres)</label>
            <input type="range" class="form-range" min="100" max="5000" step="100" [(ngModel)]="circleRadius" name="circleRadius">
            <div class="range-value">{{ circleRadius }} m</div>
          </div>
        </div>

        <!-- Onglet Secteur -->
        <div class="tab-content" [class.active]="currentTab === 'secteur'">
          <div class="form-group">
            <label class="form-label">Type de secteur</label>
            <select class="form-select" [(ngModel)]="selectedSecteurType" name="secteurType" (change)="onSecteurTypeChange()">
              <option value="">Sélectionner...</option>
              <option value="arrondissement">Arrondissement</option>
              <option value="quartier">Quartier</option>
              <option value="commune">Commune</option>
              <option value="zone-amenagement">Zone d'aménagement</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Secteur spécifique</label>
            <select class="form-select" [(ngModel)]="selectedSecteur" name="secteur">
              <option value="">Choisir un secteur...</option>
              <option *ngFor="let secteur of secteurs" [value]="secteur.id">{{ secteur.nom }}</option>
            </select>
          </div>
        </div>

        <!-- Onglet Distance -->
        <div class="tab-content" [class.active]="currentTab === 'distance'">
          <div class="form-group">
            <label class="form-label">Point de référence</label>
            <div class="draw-tools">
              <button class="draw-btn" [class.active]="currentPointMode === 'click'" (click)="setPointMode('click')">
                📍 Clic carte
              </button>
              <button class="draw-btn" [class.active]="currentPointMode === 'coords'" (click)="setPointMode('coords')">
                🎯 Coordonnées
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Rayon de recherche</label>
            <input type="range" class="distance-slider" min="50" max="5000" [value]="distanceValue" (input)="onDistanceChange($event)">
            <div class="slider-value">{{ distanceValue >= 1000 ? (distanceValue / 1000).toFixed(1) + ' km' : distanceValue + ' mètres' }}</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Type de distance</label>
            <select class="form-select">
              <option value="euclidienne">Distance euclidienne</option>
              <option value="reseau">Distance réseau routier</option>
            </select>
          </div>
        </div>
      </div>

      <div class="query-section">
        <h3 class="section-title">🔧 Filtres Additionnels</h3>
        
        <div class="form-group">
          <label class="form-label">Statut foncier</label>
          <select class="form-select" [(ngModel)]="filters.statutFoncier" name="statutFoncier">
            <option value="">Tous</option>
            <option value="tf">Titre Foncier (TF)</option>
            <option value="r">Réquisition (R)</option>
            <option value="ni">Non Immatriculé (NI)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Zonage urbanistique</label>
          <select class="form-select" [(ngModel)]="filters.zonage" name="zonage">
            <option value="">Tous</option>
            <option value="r2">Zone R+2</option>
            <option value="r4">Zone R+4</option>
            <option value="villas">Zone Villas</option>
            <option value="industriel">Zone Industrielle</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Surface minimale (m²)</label>
          <input type="number" class="form-input" placeholder="Ex: 100" [(ngModel)]="filters.surfaceMin" name="surfaceMin">
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" (click)="executeQuery()" [disabled]="isLoading">
          🔍 Lancer la requête
        </button>
        <button class="btn btn-secondary" (click)="clearQuery()" [disabled]="isLoading">
          🗑️ Effacer
        </button>
      </div>
    </div>

    <div class="results-panel">
      <div class="results-header">
        <div class="results-title">
          📊 Résultats de recherche
          <span class="results-count">{{ resultsCount }}</span>
        </div>
        <div class="export-buttons" *ngIf="hasResults">
          <button class="btn-export" (click)="exportResults('excel')">📊 Excel</button>
          <button class="btn-export" (click)="exportResults('csv')">📋 CSV</button>
          <button class="btn-export" (click)="exportResults('gpkg')">🗺️ GeoPackage</button>
          <button class="btn-export" (click)="exportResults('pdf')">📄 PDF Carte</button>
        </div>
      </div>

      <div class="summary-cards" *ngIf="hasResults">
        <div class="summary-card">
          <div class="summary-value">{{ summary.totalParcelles }}</div>
          <div class="summary-label">Parcelles trouvées</div>
        </div>
        <div class="summary-card">
          <div class="summary-value">{{ (summary.surfaceTotale / 10000).toFixed(2) }}</div>
          <div class="summary-label">Surface totale (ha)</div>
        </div>
        <div class="summary-card">
          <div class="summary-value">{{ (summary.surfaceImposable / 10000).toFixed(2) }}</div>
          <div class="summary-label">Surface imposable (ha)</div>
        </div>
        <div class="summary-card">
          <div class="summary-value">{{ summary.recettePrevue | number }}</div>
          <div class="summary-label">Recette prévue (DH)</div>
        </div>
      </div>

      <div class="map-container">
        <!-- Carte interactive avec les mêmes couches que la création de parcelle -->
        <app-map
          mapId="spatial-queries-map"
          [options]="mapOptions"
          [parcelles]="[]"
          [showControls]="true"
          [showLayers]="true"
          [enableSelection]="false"
          [enableDrawing]="true"
          (geometryDrawn)="onGeometryDrawn($event)"
          (mapReady)="onMapReady($event)">
        </app-map>
        
        <!-- Instructions de dessin -->
        <div class="drawing-instructions" [class.show]="currentTab === 'emprise' && isDrawing">
          Cliquez sur la carte pour dessiner votre zone de recherche
        </div>
        
        <!-- Indicateur de chargement -->
        <div class="loading" [class.show]="isLoading">
          <div class="spinner"></div>
          <div class="loading-text">Recherche en cours...</div>
        </div>
      </div>

      <div class="results-table">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Référence</th>
                <th>Propriétaire</th>
                <th>Statut</th>
                <th>Surface (m²)</th>
                <th>Zone</th>
                <th>Montant TNB</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="!hasResults">
                <td colspan="7" class="no-results">
                  Aucune requête lancée - Utilisez les outils de recherche ci-dessus
                </td>
              </tr>
              <tr *ngFor="let parcelle of queryResults?.parcelles">
                <td><strong>{{ parcelle.referenceFonciere }}</strong></td>
                <td>{{ parcelle.proprietaire }}</td>
                <td><span class="status-badge" [class]="'status-' + parcelle.statutFoncier.toLowerCase()">{{ parcelle.statutFoncier }}</span></td>
                <td>{{ parcelle.surfaceCadastrale | number }}</td>
                <td>{{ parcelle.zoneUrbanistique }}</td>
                <td><strong>{{ parcelle.montantTNB | number }} DH</strong></td>
                <td>
                  <button class="btn-export" (click)="viewParcel(parcelle.referenceFonciere)">👁️ Voir</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
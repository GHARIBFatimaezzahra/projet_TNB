<!-- Interface Recherche Avancée -->
<div class="interface-container">
  <div class="interface-header">
    <h2><i class="fas fa-search"></i> Recherche Avancée - Parcelles TNB</h2>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="goBack()">
        <i class="fas fa-arrow-left"></i> Retour
      </button>
      <button class="btn btn-primary" (click)="exportResults()">
        <i class="fas fa-download"></i> Exporter résultats
      </button>
    </div>
  </div>

  <!-- Formulaire de recherche -->
  <div class="search-form-container">
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-filter"></i> Critères de recherche</h3>
        <div class="header-actions">
          <button class="btn btn-secondary btn-sm" (click)="resetFilters()">
            <i class="fas fa-undo"></i> Réinitialiser
          </button>
          <button class="btn btn-primary btn-sm" (click)="applySearch()">
            <i class="fas fa-search"></i> Rechercher
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="search-grid">
          <!-- Recherche textuelle -->
          <div class="search-section">
            <h4><i class="fas fa-keyboard"></i> Recherche textuelle</h4>
            <div class="form-group">
              <label><i class="fas fa-hashtag"></i> Référence foncière</label>
                              <input type="text" [(ngModel)]="searchFilters.reference_fonciere" 
                     placeholder="Ex: TF-123456" class="form-control">
            </div>
            <div class="form-group">
              <label><i class="fas fa-user"></i> Nom du propriétaire</label>
                              <input type="text" [(ngModel)]="searchFilters.proprietaire_nom" 
                     placeholder="Ex: ALAMI Mohammed" class="form-control">
            </div>
            <div class="form-group">
              <label><i class="fas fa-id-card"></i> CIN/RC</label>
                              <input type="text" [(ngModel)]="searchFilters.proprietaire_cin" 
                     placeholder="Ex: AB123456" class="form-control">
            </div>
          </div>

          <!-- Critères spatiaux -->
          <div class="search-section">
            <h4><i class="fas fa-map-marker-alt"></i> Critères spatiaux</h4>
            <div class="form-group">
              <label><i class="fas fa-map"></i> Zone urbanistique</label>
                              <select [(ngModel)]="searchFilters.zone_urbanistique" class="form-control">
                <option value="">Toutes les zones</option>
                <option value="R1">R1 - Résidentiel</option>
                <option value="R2">R2 - Résidentiel étendu</option>
                <option value="R3">R3 - Résidentiel dense</option>
                <option value="I">I - Industriel</option>
                <option value="C">C - Commercial</option>
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-building"></i> Secteur</label>
              <select [(ngModel)]="searchFilters.secteur" class="form-control">
                <option value="">Tous les secteurs</option>
                <option value="centre">Centre-ville</option>
                <option value="nord">Secteur Nord</option>
                <option value="sud">Secteur Sud</option>
                <option value="est">Secteur Est</option>
                <option value="ouest">Secteur Ouest</option>
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-ruler-combined"></i> Surface (m²)</label>
              <div class="range-inputs">
                <input type="number" [(ngModel)]="searchFilters.surface_min" 
                       placeholder="Min" class="form-control">
                <span class="range-separator">à</span>
                <input type="number" [(ngModel)]="searchFilters.surface_max" 
                       placeholder="Max" class="form-control">
              </div>
            </div>
          </div>

          <!-- Critères fiscaux -->
          <div class="search-section">
            <h4><i class="fas fa-money-bill-wave"></i> Critères fiscaux</h4>
            <div class="form-group">
              <label><i class="fas fa-chart-line"></i> Statut fiscal</label>
                              <select [(ngModel)]="searchFilters.statut_fiscal" class="form-control">
                <option value="">Tous les statuts</option>
                <option value="imposable">Imposable</option>
                <option value="exonere">Exonéré</option>
                <option value="en_cours">En cours de traitement</option>
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-coins"></i> Montant TNB (DH)</label>
              <div class="range-inputs">
                                 <input type="number" [(ngModel)]="searchFilters.tnb_min" 
                       placeholder="Min" class="form-control">
                <span class="range-separator">à</span>
                                 <input type="number" [(ngModel)]="searchFilters.tnb_max" 
                       placeholder="Max" class="form-control">
              </div>
            </div>
            <div class="form-group">
              <label><i class="fas fa-calendar-alt"></i> Année fiscale</label>
                             <select [(ngModel)]="searchFilters.annee_fiscale" class="form-control">
                <option value="">Toutes les années</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Recherche spatiale avancée -->
        <div class="spatial-search-section">
          <h4><i class="fas fa-draw-polygon"></i> Recherche spatiale avancée</h4>
          <div class="spatial-tools">
            <button class="btn btn-outline-primary" (click)="activateSpatialTool('point')">
              <i class="fas fa-map-pin"></i> Recherche par point
            </button>
            <button class="btn btn-outline-primary" (click)="activateSpatialTool('polygon')">
              <i class="fas fa-vector-square"></i> Recherche par polygone
            </button>
            <button class="btn btn-outline-primary" (click)="activateSpatialTool('buffer')">
              <i class="fas fa-circle"></i> Recherche par buffer
            </button>
            <button class="btn btn-outline-primary" (click)="activateSpatialTool('intersection')">
              <i class="fas fa-object-intersect"></i> Intersection avec couche
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Résultats de recherche -->
  <div class="search-results-container" *ngIf="searchResults.length > 0">
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-list"></i> Résultats de recherche</h3>
        <div class="results-info">
          <span class="results-count">
            <i class="fas fa-info-circle"></i> {{ searchResults.length }} parcelles trouvées
          </span>
          <span class="results-time">
            <i class="fas fa-clock"></i> Recherche effectuée en {{ searchTime }}ms
          </span>
        </div>
      </div>
      <div class="card-body">
        <div class="results-toolbar">
          <div class="toolbar-left">
            <button class="btn btn-outline-secondary btn-sm" (click)="selectAllResults()">
              <i class="fas fa-check-square"></i> Tout sélectionner
            </button>
            <button class="btn btn-outline-secondary btn-sm" (click)="deselectAllResults()">
              <i class="fas fa-square"></i> Désélectionner tout
            </button>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-success btn-sm" (click)="exportSelectedResults()">
              <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn btn-info btn-sm" (click)="exportSelectedResultsCSV()">
              <i class="fas fa-file-csv"></i> CSV
            </button>
            <button class="btn btn-warning btn-sm" (click)="exportSelectedResultsPDF()">
              <i class="fas fa-file-pdf"></i> PDF
            </button>
          </div>
        </div>

        <div class="results-table">
          <table class="table">
            <thead>
              <tr>
                <th><input type="checkbox" (change)="toggleAllResults($event)"></th>
                <th><i class="fas fa-hashtag"></i> Référence</th>
                <th><i class="fas fa-user"></i> Propriétaire</th>
                <th><i class="fas fa-ruler-combined"></i> Surface</th>
                <th><i class="fas fa-map"></i> Zone</th>
                <th><i class="fas fa-coins"></i> TNB</th>
                <th><i class="fas fa-eye"></i> Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let parcelle of searchResults; trackBy: trackByParcelleId">
                <td>
                  <input type="checkbox" [checked]="isParcelleSelected(parcelle.id)" 
                         (change)="toggleParcelleSelection(parcelle.id)">
                </td>
                <td>
                                     <span class="reference-badge">{{ parcelle.reference_fonciere }}</span>
                </td>
                                 <td>{{ parcelle.proprietaire_nom }}</td>
                                 <td>{{ parcelle.surface_totale }} m²</td>
                <td>
                                     <span class="zone-badge" [ngClass]="getZoneClass(parcelle.zone_urbanistique)">
                     {{ parcelle.zone_urbanistique }}
                  </span>
                </td>
                <td>
                                     <span class="tnb-amount">{{ parcelle.montant_total_tnb }} DH</span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="btn btn-primary btn-xs" (click)="viewParcelle(parcelle.id)" 
                            title="Voir détails">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-secondary btn-xs" (click)="editParcelle(parcelle.id)" 
                            title="Modifier">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-info btn-xs" (click)="showOnMap(parcelle.id)" 
                            title="Voir sur carte">
                      <i class="fas fa-map-marker-alt"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- État vide si aucun résultat -->
  <div class="empty-state" *ngIf="searchPerformed && searchResults.length === 0">
    <div class="card">
      <div class="card-body">
        <div class="empty-content">
          <i class="fas fa-search"></i>
          <h3>Aucun résultat trouvé</h3>
          <p>Aucune parcelle ne correspond aux critères de recherche spécifiés.</p>
          <div class="empty-actions">
            <button class="btn btn-primary" (click)="resetFilters()">
              <i class="fas fa-undo"></i> Modifier les critères
            </button>
            <button class="btn btn-secondary" (click)="showAllParcelles()">
              <i class="fas fa-list"></i> Voir toutes les parcelles
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- État initial si aucune recherche effectuée -->
  <div class="initial-state" *ngIf="!searchPerformed">
    <div class="card">
      <div class="card-body">
        <div class="initial-content">
          <i class="fas fa-search-plus"></i>
          <h3>Recherche avancée des parcelles</h3>
          <p>Utilisez les critères ci-dessus pour effectuer une recherche précise dans la base de données des parcelles TNB.</p>
          <div class="initial-tips">
            <div class="tip-item">
              <i class="fas fa-lightbulb"></i>
              <span>Vous pouvez combiner plusieurs critères pour affiner votre recherche</span>
            </div>
            <div class="tip-item">
              <i class="fas fa-map-marked-alt"></i>
              <span>Utilisez les outils spatiaux pour des requêtes géographiques</span>
            </div>
            <div class="tip-item">
              <i class="fas fa-download"></i>
              <span>Exportez vos résultats dans différents formats</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <!-- Header avec informations principales -->
  <div class="header-section">
    <div>
      <h2>Détail de parcelle - {{ parcelle?.referenceFonciere || 'TF-456789' }}</h2>
      <div class="header-meta">
        <span class="badge badge-success">
          <i class="fas fa-check-circle"></i> {{ parcelle?.statut || 'Publié' }}
        </span>
        <span class="last-modified">
          Dernière modification: {{ parcelle?.dateModification ? (parcelle.dateModification | date:'dd/MM/yyyy') : '15/03/2024' }} par {{ parcelle?.derniereModificationPar || 'tech.sig' }}
        </span>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="goBack()">
        <i class="fas fa-arrow-left"></i> Retour
      </button>
      <button class="btn btn-primary" (click)="localiserParcelle()">
        <i class="fas fa-map-marker-alt"></i> Localiser
      </button>
      <button class="btn btn-secondary" (click)="editParcelle()">
        <i class="fas fa-edit"></i> Modifier
      </button>
    </div>
  </div>

  <!-- Vue d'ensemble avec métriques -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-icon surface-icon">
          <i class="fas fa-ruler-combined"></i>
        </div>
        <div class="stat-info">
          <h3>{{ parcelle?.surfaceCadastrale ? (parcelle.surfaceCadastrale | number:'1.0-0') : '2,450' }} m²</h3>
          <p>Surface cadastrale</p>
          <div class="stat-trend">
            <i class="fas fa-info-circle"></i> SIG: {{ parcelle?.surfaceSIG ? (parcelle.surfaceSIG | number:'1.2-2') : '2,453.67' }} m²
          </div>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-icon tnb-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-info">
          <h3>{{ parcelle?.tnbCalculee ? (parcelle.tnbCalculee | number:'1.0-0') : '22,000' }} DH</h3>
          <p>TNB calculée</p>
          <div class="stat-trend">
            <i class="fas fa-info-circle"></i> {{ parcelle?.tarifUnitaire || '10' }} DH/m²
          </div>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-icon owners-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
          <h3>{{ parcelle?.proprietaires?.length || '2' }}</h3>
          <p>Propriétaires</p>
          <div class="stat-trend">
            <i class="fas fa-info-circle"></i> {{ parcelle?.typePropriete || 'Indivision' }}
          </div>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-icon documents-icon">
          <i class="fas fa-file-invoice"></i>
        </div>
        <div class="stat-info">
          <h3>{{ parcelle?.fichesGenerees || '3' }}</h3>
          <p>Fiches générées</p>
          <div class="stat-trend">
            <i class="fas fa-info-circle"></i> Dernière: {{ parcelle?.derniereFiche ? (parcelle.derniereFiche | date:'dd/MM/yyyy') : '15/03/2024' }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Onglets de détail -->
  <div class="nav-tabs">
    <button class="nav-tab" [class.active]="activeTab === 'overview'" (click)="setActiveTab('overview')">
      <i class="fas fa-info-circle"></i>
      Vue d'ensemble
    </button>
    <button class="nav-tab" [class.active]="activeTab === 'geometry'" (click)="setActiveTab('geometry')">
      <i class="fas fa-map"></i>
      Géométrie & Localisation
    </button>
    <button class="nav-tab" [class.active]="activeTab === 'owners'" (click)="setActiveTab('owners')">
      <i class="fas fa-users"></i>
      Propriétaires & Quote-parts
    </button>
    <button class="nav-tab" [class.active]="activeTab === 'fiscal'" (click)="setActiveTab('fiscal')">
      <i class="fas fa-calculator"></i>
      Données fiscales
    </button>
    <button class="nav-tab" [class.active]="activeTab === 'documents'" (click)="setActiveTab('documents')">
      <i class="fas fa-paperclip"></i>
      Documents joints
    </button>
    <button class="nav-tab" [class.active]="activeTab === 'history'" (click)="setActiveTab('history')">
      <i class="fas fa-history"></i>
      Historique
    </button>
  </div>

  <!-- Contenu des onglets -->
  
  <!-- Vue d'ensemble -->
  <div class="tab-content" *ngIf="activeTab === 'overview'">
    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <h3>Informations foncières</h3>
          <button class="btn btn-secondary btn-sm" (click)="editInformationsFoncieres()">
            <i class="fas fa-edit"></i>
          </button>
        </div>
        <div class="card-body">
          <div class="info-grid">
            <div class="info-item">
              <label>RÉFÉRENCE FONCIÈRE</label>
              <p class="info-value">{{ parcelle?.referenceFonciere || 'TF-456789' }}</p>
              <small>{{ parcelle?.typeTitre || 'Titre Foncier' }}</small>
            </div>
            
            <div class="info-item">
              <label>ZONE URBANISTIQUE</label>
              <p class="info-value">
                <span class="badge badge-secondary">{{ parcelle?.zoneUrbanistique || 'R2 - Résidentiel moyen' }}</span>
              </p>
            </div>
            
            <div class="info-item">
              <label>STATUT D'OCCUPATION</label>
              <p class="info-value">{{ parcelle?.statutOccupation || 'Terrain nu' }}</p>
              <small>{{ parcelle?.statutOccupationDetail || 'Pas de construction déclarée' }}</small>
            </div>
            
            <div class="info-item">
              <label>ADRESSE</label>
              <p class="info-value">{{ parcelle?.adresse || 'Secteur Lazaret, Quartier Salam' }}</p>
              <small>{{ parcelle?.adresseDetail || 'Oujda, Province d\'Oujda-Angad' }}</small>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3>Données techniques</h3>
        </div>
        <div class="card-body">
          <div class="info-grid">
            <div class="info-item">
              <label>SURFACE CADASTRALE</label>
              <p class="info-value">{{ parcelle?.surfaceCadastrale ? (parcelle.surfaceCadastrale | number:'1.0-0') : '2,450' }} m²</p>
            </div>
            
            <div class="info-item">
              <label>SURFACE IMPOSABLE</label>
              <p class="info-value">{{ parcelle?.surfaceImposable ? (parcelle.surfaceImposable | number:'1.0-0') : '2,200' }} m²</p>
            </div>
            
            <div class="info-item">
              <label>SURFACE CALCULÉE (SIG)</label>
              <p class="info-value">{{ parcelle?.surfaceSIG ? (parcelle.surfaceSIG | number:'1.2-2') : '2,453.67' }} m²</p>
              <small class="warning-text" *ngIf="parcelle?.ecartSurface">
                <i class="fas fa-exclamation-triangle"></i>
                Écart de {{ parcelle.ecartSurface | number:'1.2-2' }} m² avec le cadastre
              </small>
            </div>
            
            <div class="info-item">
              <label>PÉRIMÈTRE</label>
              <p class="info-value">{{ parcelle?.perimetre ? (parcelle.perimetre | number:'1.2-2') : '198.45' }} m</p>
            </div>
            
            <div class="info-item">
              <label>COORDONNÉES CENTROÏDE</label>
              <p class="info-value coords">
                X: {{ parcelle?.coordonneesCentroide?.x ? (parcelle.coordonneesCentroide.x | number:'1.2-2') : '651,289.23' }}<br>
                Y: {{ parcelle?.coordonneesCentroide?.y ? (parcelle.coordonneesCentroide.y | number:'1.2-2') : '372,165.34' }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Résumé fiscal -->
    <div class="card">
      <div class="card-header">
        <h3>Résumé fiscal TNB {{ parcelle?.anneeFiscale || '2024' }}</h3>
        <button class="btn btn-success btn-sm" (click)="genererFichesPDF()">
          <i class="fas fa-file-pdf"></i>
          Fiches PDF
        </button>
      </div>
      <div class="card-body">
        <div class="grid-3">
          <div class="fiscal-summary-item">
            <div class="fiscal-value">{{ parcelle?.tarifUnitaire || '10' }} DH/m²</div>
            <div class="fiscal-label">Tarif unitaire</div>
          </div>
          
          <div class="fiscal-summary-item">
            <div class="fiscal-value">{{ parcelle?.tnbCalculee ? (parcelle.tnbCalculee | number:'1.0-0') : '22,000' }} DH</div>
            <div class="fiscal-label">TNB totale</div>
          </div>
          
          <div class="fiscal-summary-item">
            <div class="fiscal-value">{{ parcelle?.tauxRecouvrement || '100' }}%</div>
            <div class="fiscal-label">Taux de recouvrement</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Géométrie & Localisation -->
  <div class="tab-content" *ngIf="activeTab === 'geometry'">
    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <h3>Carte de localisation</h3>
          <div class="map-actions">
            <button class="btn btn-secondary btn-sm" (click)="pleinEcran()">
              <i class="fas fa-expand"></i> Plein écran
            </button>
            <button class="btn btn-primary btn-sm" (click)="exportCarte()">
              <i class="fas fa-download"></i> Export carte
            </button>
          </div>
        </div>
        <div class="card-body map-container">
          <app-map 
            [parcelles]="[]"
            [showControls]="true">
          </app-map>
        </div>
      </div>
      
      <div>
        <!-- Informations géométriques -->
        <div class="card">
          <div class="card-header">
            <h4>Caractéristiques géométriques</h4>
          </div>
          <div class="card-body">
            <div class="geometry-info">
              <div class="geometry-item">
                <span>Type géométrie:</span>
                <strong>{{ parcelle?.typeGeometrie || 'Polygone' }}</strong>
              </div>
              <div class="geometry-item">
                <span>Nombre de sommets:</span>
                <strong>{{ parcelle?.nombreSommets || '12' }} points</strong>
              </div>
              <div class="geometry-item">
                <span>Surface calculée:</span>
                <strong>{{ parcelle?.surfaceSIG ? (parcelle.surfaceSIG | number:'1.2-2') : '2,453.67' }} m²</strong>
              </div>
              <div class="geometry-item">
                <span>Périmètre:</span>
                <strong>{{ parcelle?.perimetre ? (parcelle.perimetre | number:'1.2-2') : '198.45' }} m</strong>
              </div>
              <div class="geometry-item">
                <span>Ratio forme:</span>
                <strong>{{ parcelle?.ratioForme || '0.78' }}</strong>
              </div>
            </div>
            
            <hr>
            
            <div class="geometry-info">
              <div class="geometry-item">
                <span>Système projection:</span>
                <strong>{{ parcelle?.systemeProjection || 'EPSG:26191' }}</strong>
              </div>
              <div class="geometry-item">
                <span>Précision:</span>
                <strong>{{ parcelle?.precision || '± 0.05' }} m</strong>
              </div>
              <div class="geometry-item">
                <span>Source géométrie:</span>
                <strong>{{ parcelle?.sourceGeometrie || 'Levé GPS-RTK' }}</strong>
              </div>
              <div class="geometry-item">
                <span>Date levé:</span>
                <strong>{{ parcelle?.dateLeve ? (parcelle.dateLeve | date:'dd/MM/yyyy') : '15/03/2024' }}</strong>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Analyse spatiale -->
        <div class="card" style="margin-top: 1rem;">
          <div class="card-header">
            <h4>Analyse spatiale</h4>
          </div>
          <div class="card-body">
            <div class="spatial-analysis">
              <h5>Parcelles voisines:</h5>
              <ul class="neighbors-list">
                <li *ngFor="let voisin of parcelle?.parcellesVoisines">
                  <i class="fas fa-arrow-up"></i> {{ voisin.direction }}: {{ voisin.reference }} ({{ voisin.zone }})
                </li>
              </ul>
              
              <h5>Équipements proches:</h5>
              <ul class="equipments-list">
                <li *ngFor="let equipement of parcelle?.equipementsProches">
                  <i [class]="equipement.icon"></i> 
                  <span class="equipment-name">{{ equipement.nom }}</span>
                  <span class="equipment-distance">({{ equipement.distance }})</span>
                  <small class="equipment-type">{{ equipement.type }}</small>
                </li>
              </ul>
              
              <h5>Voiries proches:</h5>
              <ul class="voiries-list">
                <li *ngFor="let voirie of parcelle?.voiriesProches">
                  <i [class]="voirie.icon"></i> 
                  <span class="voirie-name">{{ voirie.nom }}</span>
                  <span class="voirie-type">{{ voirie.type }}</span>
                  <span class="voirie-distance">({{ voirie.distance }})</span>
                  <div class="voirie-details">
                    <small>Largeur: {{ voirie.largeur }} | État: {{ voirie.etat }}</small>
                  </div>
                </li>
              </ul>
              
              <h5>Grands espaces:</h5>
              <ul class="grands-espaces-list">
                <li *ngFor="let espace of parcelle?.grandsEspaces">
                  <i [class]="espace.icon"></i> 
                  <span class="espace-name">{{ espace.nom }}</span>
                  <span class="espace-type">{{ espace.type }}</span>
                  <span class="espace-distance">({{ espace.distance }})</span>
                  <div class="espace-details">
                    <small>Superficie: {{ espace.superficie }}</small>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Table des coordonnées -->
    <div class="card">
      <div class="card-header">
        <h3>Coordonnées des sommets</h3>
        <div class="coords-actions">
          <button class="btn btn-secondary btn-sm" (click)="copierCoordonnees()">
            <i class="fas fa-copy"></i> Copier
          </button>
          <button class="btn btn-primary btn-sm" (click)="exportDXF()">
            <i class="fas fa-download"></i> Export DXF
          </button>
        </div>
      </div>
      <div class="card-body" style="padding: 0;">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Point</th>
                <th>X (Lambert)</th>
                <th>Y (Lambert)</th>
                <th>Longitude (WGS84)</th>
                <th>Latitude (WGS84)</th>
                <th>Distance au suivant</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let point of parcelle?.coordonneesSommets; let i = index">
                <td><strong>P{{ i + 1 }}</strong></td>
                <td>{{ point.xLambert | number:'1.2-2' }}</td>
                <td>{{ point.yLambert | number:'1.2-2' }}</td>
                <td>{{ point.longitude | number:'1.6-6' }}°</td>
                <td>{{ point.latitude | number:'1.6-6' }}°</td>
                <td>{{ point.distanceSuivant | number:'1.2-2' }} m</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Propriétaires & Quote-parts -->
  <div class="tab-content" *ngIf="activeTab === 'owners'">
    <div class="card">
      <div class="card-header">
        <h3>Propriétaires et répartition des quote-parts</h3>
        <button class="btn btn-primary btn-sm" (click)="modifierProprietaires()">
          <i class="fas fa-edit"></i> Modifier
        </button>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          Cette parcelle est en {{ parcelle?.typePropriete || 'indivision' }} entre {{ parcelle?.proprietaires?.length || '2' }} propriétaires. Les quote-parts totalisent {{ getTotalQuoteParts() }}%.
        </div>

        <div class="grid-2">
          <div class="card owner-card" *ngFor="let proprietaire of parcelle?.proprietaires; let i = index" 
               [style.border-color]="getOwnerCardColor(i)">
            <div class="card-body">
              <div class="owner-header">
                <div>
                  <h4>{{ proprietaire.nom }}</h4>
                  <small>CIN: {{ proprietaire.cin }}</small>
                </div>
                <span class="badge" [class]="'badge-' + getOwnerBadgeClass(i)" 
                      style="font-size: 1rem; padding: 0.5rem 1rem;">
                  {{ proprietaire.quotePart }}%
                </span>
              </div>
              <div class="owner-address">
                <div><strong>Adresse:</strong></div>
                <div>{{ proprietaire.adresse }}</div>
                <div>{{ proprietaire.ville }} {{ proprietaire.codePostal }}</div>
              </div>
              <div class="owner-tnb" [style.background]="getOwnerTnbBackground(i)">
                <strong>TNB individuelle: {{ calculerTnbIndividuelle(proprietaire.quotePart) | number:'1.0-0' }} DH</strong>
                <div class="tnb-calculation">
                  {{ parcelle?.tnbCalculee ? (parcelle.tnbCalculee | number:'1.0-0') : '22,000' }} DH × {{ proprietaire.quotePart }}% = {{ calculerTnbIndividuelle(proprietaire.quotePart) | number:'1.0-0' }} DH
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="indivision-summary">
          <h5>Récapitulatif de l'indivision</h5>
          <div class="summary-grid">
            <div class="summary-item">
              <strong>{{ parcelle?.proprietaires?.length || '2' }}</strong>
              <span>Propriétaires</span>
            </div>
            <div class="summary-item">
              <strong>{{ getTotalQuoteParts() }}%</strong>
              <span>Quote-parts</span>
            </div>
            <div class="summary-item">
              <strong>{{ parcelle?.tnbCalculee ? (parcelle.tnbCalculee | number:'1.0-0') : '22,000' }} DH</strong>
              <span>TNB totale</span>
            </div>
            <div class="summary-item">
              <strong [style.color]="'var(--success-color)'">Valid</strong>
              <span>Statut</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Données fiscales -->
  <div class="tab-content" *ngIf="activeTab === 'fiscal'">
    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <h3>Calcul TNB détaillé</h3>
          <button class="btn btn-primary btn-sm" (click)="recalculerTNB()">
            <i class="fas fa-calculator"></i> Recalculer
          </button>
        </div>
        <div class="card-body">
          <div class="formula-box">
            <h5>Formule de calcul</h5>
            <p>TNB = Surface × Tarif × Coefficient × Quote-part</p>
          </div>
          
          <div class="calculation-section">
            <label><strong>Calcul de base:</strong></label>
            <div class="calculation-box">
              {{ parcelle?.surfaceImposable ? (parcelle.surfaceImposable | number:'1.0-0') : '2,200' }} m² × {{ parcelle?.tarifUnitaire || '10' }} DH/m² × {{ parcelle?.coefficientAbattement || '1.0' }} = <strong>{{ parcelle?.tnbCalculee ? (parcelle.tnbCalculee | number:'1.0-0') : '22,000' }} DH</strong>
            </div>
          </div>
          
          <h5>Répartition par propriétaire:</h5>
          
          <div class="owner-calculation" *ngFor="let proprietaire of parcelle?.proprietaires">
            <div class="calculation-row">
              <div>
                <strong>{{ proprietaire.nom }}</strong><br>
                <small>Quote-part: {{ proprietaire.quotePart }}% ({{ proprietaire.quotePart / 100 }})</small>
              </div>
              <div class="calculation-result">
                <strong>{{ calculerTnbIndividuelle(proprietaire.quotePart) | number:'1.0-0' }} DH</strong><br>
                <small>{{ parcelle?.tnbCalculee ? (parcelle.tnbCalculee | number:'1.0-0') : '22,000' }} × {{ proprietaire.quotePart / 100 }}</small>
              </div>
            </div>
          </div>
          
          <hr>
          <div class="total-calculation">
            <strong>Total TNB:</strong>
            <strong>{{ parcelle?.tnbCalculee ? (parcelle.tnbCalculee | number:'1.0-0') : '22,000' }} DH</strong>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Paramètres fiscaux</h3>
        </div>
        <div class="card-body">
          <div class="fiscal-params">
            <div class="param-item">
              <span>Zone urbanistique:</span>
              <strong>{{ parcelle?.zoneUrbanistique || 'R2 - Résidentiel moyen' }}</strong>
            </div>
            <div class="param-item">
              <span>Catégorie fiscale:</span>
              <strong>{{ parcelle?.categorieFiscale || 'Terrain nu résidentiel' }}</strong>
            </div>
            <div class="param-item">
              <span>Tarif unitaire {{ parcelle?.anneeFiscale || '2024' }}:</span>
              <strong>{{ parcelle?.tarifUnitaire || '10' }} DH/m²</strong>
            </div>
            <div class="param-item">
              <span>Surface imposable:</span>
              <strong>{{ parcelle?.surfaceImposable ? (parcelle.surfaceImposable | number:'1.0-0') : '2,200' }} m²</strong>
            </div>
            <div class="param-item">
              <span>Coefficient d'abattement:</span>
              <strong>{{ parcelle?.coefficientAbattement || '1.0' }} (aucun)</strong>
            </div>
          </div>

          <hr>
          
          <h5>Évolution des tarifs</h5>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Année</th>
                  <th>Tarif (DH/m²)</th>
                  <th>Évolution</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let tarif of parcelle?.evolutionTarifs" 
                    [style.background]="tarif.annee === parcelle?.anneeFiscale ? 'rgba(5, 150, 105, 0.05)' : ''">
                  <td><strong *ngIf="tarif.annee === parcelle?.anneeFiscale">{{ tarif.annee }}</strong>
                      <span *ngIf="tarif.annee !== parcelle?.anneeFiscale">{{ tarif.annee }}</span>
                  </td>
                  <td><strong *ngIf="tarif.annee === parcelle?.anneeFiscale">{{ tarif.tarif | number:'1.2-2' }}</strong>
                      <span *ngIf="tarif.annee !== parcelle?.anneeFiscale">{{ tarif.tarif | number:'1.2-2' }}</span>
                  </td>
                  <td>
                    <span class="badge" [class]="'badge-' + tarif.evolutionClass">
                      <i [class]="tarif.evolutionIcon"></i> {{ tarif.evolution }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Documents joints -->
  <div class="tab-content" *ngIf="activeTab === 'documents'">
    <div class="card">
      <div class="card-header">
        <h3>Documents et pièces jointes</h3>
        <button class="btn btn-primary btn-sm" (click)="ajouterDocument()">
          <i class="fas fa-upload"></i> Ajouter document
        </button>
      </div>
      <div class="card-body">
        <div class="grid-2">
          <div class="card document-card" *ngFor="let doc of parcelle?.documents" 
               [style.border-left-color]="getDocumentColor(doc.type)">
            <div class="card-body">
              <div class="document-header">
                <div class="document-icon" [style.background]="getDocumentIconBackground(doc.type)">
                  <i [class]="getFileIcon(doc.type)"></i>
                </div>
                <div>
                  <h5>{{ doc.nom }}</h5>
                  <small>{{ doc.nomFichier }}</small>
                </div>
              </div>
              <div class="document-meta">
                Taille: {{ doc.taille | fileSize }} | Ajouté le: {{ doc.dateCreation | date:'dd/MM/yyyy' }}<br>
                Par: {{ doc.ajoutePar }}
              </div>
              <div class="document-actions">
                <button class="btn btn-secondary btn-sm" (click)="telechargerDocument(doc)">
                  <i class="fas fa-download"></i> Télécharger
                </button>
                <button class="btn btn-primary btn-sm" (click)="previewDocument(doc)">
                  <i class="fas fa-eye"></i> Aperçu
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <strong>Note:</strong> Tous les documents sont stockés de manière sécurisée et horodatés. L'accès est limité aux utilisateurs autorisés selon leurs privilèges.
        </div>
      </div>
    </div>
  </div>

  <!-- Historique -->
  <div class="tab-content" *ngIf="activeTab === 'history'">
    <div class="card">
      <div class="card-header">
        <h3>Historique des modifications</h3>
        <div class="history-actions">
          <button class="btn btn-secondary btn-sm" (click)="filtrerHistorique()">
            <i class="fas fa-filter"></i> Filtrer
          </button>
          <button class="btn btn-primary btn-sm" (click)="exporterHistorique()">
            <i class="fas fa-download"></i> Export historique
          </button>
        </div>
      </div>
      <div class="card-body" style="padding: 0;">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Date/Heure</th>
                <th>Utilisateur</th>
                <th>Action</th>
                <th>Champs modifiés</th>
                <th>Commentaire</th>
                <th>Version</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let event of parcelle?.historique" 
                  [style.background]="getHistoryRowBackground(event.type)">
                <td>
                  <strong>{{ event.date | date:'dd/MM/yyyy HH:mm' }}</strong><br>
                  <small>{{ getTimeAgo(event.date) }}</small>
                </td>
                <td>
                  <div>
                    <strong>{{ event.utilisateur }}</strong><br>
                    <small>{{ event.roleUtilisateur }}</small>
                  </div>
                </td>
                <td>
                  <span class="badge" [class]="'badge-' + event.badgeClass">
                    <i [class]="event.icon"></i> {{ event.action }}
                  </span>
                </td>
                <td>
                  <div class="champs-modifies">
                    <div *ngFor="let champ of event.champsModifies">
                      • {{ champ }}
                    </div>
                  </div>
                </td>
                <td>{{ event.description }}</td>
                <td><strong>{{ event.version }}</strong></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Statistiques d'historique -->
    <div class="grid-3" style="margin-top: 1.5rem;">
      <div class="card">
        <div class="card-body" style="text-align: center;">
          <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">{{ parcelle?.historique?.length || '5' }}</h3>
          <p style="margin: 0; color: var(--gray-600);">Modifications totales</p>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body" style="text-align: center;">
          <h3 style="color: var(--success-color); margin-bottom: 0.5rem;">{{ getNombreUtilisateurs() }}</h3>
          <p style="margin: 0; color: var(--gray-600);">Utilisateurs impliqués</p>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body" style="text-align: center;">
          <h3 style="color: var(--info-color); margin-bottom: 0.5rem;">{{ getJoursDepuisCreation() }}</h3>
          <p style="margin: 0; color: var(--gray-600);">Jours depuis création</p>
        </div>
      </div>
    </div>
  </div>
</div>
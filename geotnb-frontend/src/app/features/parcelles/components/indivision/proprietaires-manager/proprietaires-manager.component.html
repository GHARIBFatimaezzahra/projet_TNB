<!-- ===================================================== -->
<!-- GESTIONNAIRE DE PROPRIÉTAIRES - INDIVISION -->
<!-- ===================================================== -->

<div class="proprietaires-manager">
  <!-- En-tête -->
  <div class="header">
    <div class="title-section">
      <h3>
        <mat-icon>group</mat-icon>
        Gestionnaire de Propriétaires
      </h3>
      <div class="stats">
        <mat-chip [matBadge]="proprietaires.length" matBadgePosition="after" matBadgeColor="primary">
          Total
        </mat-chip>
        <mat-chip [matBadge]="activeProprietaires.length" matBadgePosition="after" matBadgeColor="accent">
          Actifs
        </mat-chip>
        <mat-chip [matBadge]="inactiveProprietaires.length" matBadgePosition="after" matBadgeColor="warn" 
                 *ngIf="inactiveProprietaires.length > 0">
          Inactifs
        </mat-chip>
      </div>
    </div>

    <div class="header-actions">
      <button mat-icon-button (click)="toggleViewMode()" 
             [matTooltip]="viewMode === 'list' ? 'Vue cartes' : 'Vue liste'">
        <mat-icon>{{ viewMode === 'list' ? 'view_module' : 'view_list' }}</mat-icon>
      </button>

      <button mat-raised-button color="primary" (click)="toggleNewProprietaireForm()" 
             [disabled]="!canAddProprietaire">
        <mat-icon>person_add</mat-icon>
        Nouveau propriétaire
      </button>
    </div>
  </div>

  <!-- Recherche de propriétaires existants -->
  <mat-card class="search-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>search</mat-icon>
        Rechercher un Propriétaire Existant
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="searchForm" class="search-form">
        <div class="search-row">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Rechercher...</mat-label>
            <input matInput formControlName="searchTerm" 
                  placeholder="Nom, prénom, CIN, email..."
                  [disabled]="readonly">
            <mat-icon matSuffix>search</mat-icon>
            <button mat-icon-button matSuffix (click)="clearSearch()" 
                   *ngIf="searchForm.get('searchTerm')?.value" type="button">
              <mat-icon>clear</mat-icon>
            </button>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Type de recherche</mat-label>
            <mat-select formControlName="searchType">
              <mat-option value="all">Tous les champs</mat-option>
              <mat-option value="nom">Nom/Prénom</mat-option>
              <mat-option value="cin">CIN/RC</mat-option>
              <mat-option value="email">Email</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Nature</mat-label>
            <mat-select formControlName="nature">
              <mat-option value="all">Toutes</mat-option>
              <mat-option value="Physique">Personne Physique</mat-option>
              <mat-option value="Morale">Personne Morale</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </form>

      <!-- Spinner de recherche -->
      <div class="search-loading" *ngIf="isSearching">
        <mat-spinner diameter="30"></mat-spinner>
        <p>Recherche en cours...</p>
      </div>

      <!-- Résultats de recherche -->
      <div class="search-results" *ngIf="hasSearchResults && !isSearching">
        <h4>Résultats de la recherche ({{ searchResults.length }})</h4>
        
        <div class="results-list">
          <div *ngFor="let result of searchResults" class="result-item">
            <div class="proprietaire-info">
              <div class="main-info">
                <mat-icon [color]="result.proprietaire.nature === 'Physique' ? 'primary' : 'accent'">
                  {{ getProprietaireIcon(result.proprietaire.nature) }}
                </mat-icon>
                <div class="details">
                  <div class="name">{{ getProprietaireDisplay(result.proprietaire) }}</div>
                  <div class="meta">
                    <span class="nature">{{ getProprietaireTypeLabel(result.proprietaire.nature) }}</span>
                    <span class="separator">•</span>
                    <span class="contact" *ngIf="result.proprietaire.telephone">
                      {{ result.proprietaire.telephone }}
                    </span>
                    <span class="separator" *ngIf="result.proprietaire.telephone && result.proprietaire.email">•</span>
                    <span class="contact" *ngIf="result.proprietaire.email">
                      {{ result.proprietaire.email }}
                    </span>
                  </div>
                </div>
              </div>
              
              <div class="match-score">
                <mat-chip [color]="result.matchScore > 80 ? 'primary' : result.matchScore > 60 ? 'accent' : ''">
                  {{ result.matchScore }}% correspondance
                </mat-chip>
              </div>
            </div>

            <div class="result-actions">
              <button mat-raised-button color="primary" 
                     (click)="addExistingProprietaire(result.proprietaire)"
                     [disabled]="readonly">
                <mat-icon>add</mat-icon>
                Ajouter
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Aucun résultat -->
      <div class="no-results" *ngIf="searchForm.get('searchTerm')?.value && searchResults.length === 0 && !isSearching">
        <mat-icon>search_off</mat-icon>
        <p>Aucun propriétaire trouvé</p>
        <button mat-button color="primary" (click)="toggleNewProprietaireForm()" 
               [disabled]="!canAddProprietaire">
          <mat-icon>person_add</mat-icon>
          Créer un nouveau propriétaire
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Formulaire nouveau propriétaire -->
  <mat-card class="new-proprietaire-card" *ngIf="showNewProprietaireForm">
    <mat-card-header>
      <mat-card-title>
        <mat-icon color="primary">person_add</mat-icon>
        Créer un Nouveau Propriétaire
      </mat-card-title>
      <button mat-icon-button (click)="toggleNewProprietaireForm()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="newProprietaireForm" (ngSubmit)="createNewProprietaire()">
        <div class="form-row">
          <!-- Nature -->
          <mat-form-field appearance="outline">
            <mat-label>Nature</mat-label>
            <mat-select formControlName="nature" required>
              <mat-option *ngFor="let option of natureOptions" [value]="option.value">
                <div class="nature-option">
                  <mat-icon>{{ option.icon }}</mat-icon>
                  <span>{{ option.label }}</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-error>La nature est requise</mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- Nom -->
          <mat-form-field appearance="outline">
            <mat-label>{{ newProprietaireForm.get('nature')?.value === 'Physique' ? 'Nom' : 'Raison sociale' }}</mat-label>
            <input matInput formControlName="nom" required>
            <mat-error>Le nom est requis (minimum 2 caractères)</mat-error>
          </mat-form-field>

          <!-- Prénom (seulement pour personne physique) -->
          <mat-form-field appearance="outline" *ngIf="newProprietaireForm.get('nature')?.value === 'Physique'">
            <mat-label>Prénom</mat-label>
            <input matInput formControlName="prenom">
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- CIN/RC -->
          <mat-form-field appearance="outline">
            <mat-label>{{ newProprietaireForm.get('nature')?.value === 'Physique' ? 'CIN' : 'Registre de Commerce' }}</mat-label>
            <input matInput formControlName="cin_ou_rc" required>
            <mat-error *ngIf="newProprietaireForm.get('cin_ou_rc')?.hasError('required')">
              {{ newProprietaireForm.get('nature')?.value === 'Physique' ? 'CIN' : 'RC' }} requis
            </mat-error>
            <mat-error *ngIf="newProprietaireForm.get('cin_ou_rc')?.hasError('invalidCin')">
              Format CIN invalide (ex: AB123456)
            </mat-error>
            <mat-error *ngIf="newProprietaireForm.get('cin_ou_rc')?.hasError('pattern')">
              Format RC invalide (chiffres uniquement)
            </mat-error>
          </mat-form-field>

          <!-- Quote-part initiale -->
          <mat-form-field appearance="outline">
            <mat-label>Quote-part initiale (%)</mat-label>
            <input matInput type="number" formControlName="quotePart" 
                  min="0.01" max="100" step="0.01">
            <span matSuffix>%</span>
            <mat-error>Quote-part entre 0.01% et 100%</mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- Téléphone -->
          <mat-form-field appearance="outline">
            <mat-label>Téléphone</mat-label>
            <input matInput formControlName="telephone" placeholder="06XXXXXXXX">
            <mat-error>Format téléphone invalide</mat-error>
          </mat-form-field>

          <!-- Email -->
          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email">
            <mat-error>Format email invalide</mat-error>
          </mat-form-field>
        </div>

        <!-- Adresse -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Adresse</mat-label>
            <textarea matInput formControlName="adresse" rows="2" 
                     placeholder="Adresse complète..."></textarea>
          </mat-form-field>
        </div>

        <!-- Actions du formulaire -->
        <div class="form-actions">
          <button type="button" mat-button (click)="toggleNewProprietaireForm()">
            <mat-icon>cancel</mat-icon>
            Annuler
          </button>
          
          <button type="submit" mat-raised-button color="primary" 
                 [disabled]="!newProprietaireForm.valid || isCreatingNew">
            <mat-spinner diameter="20" *ngIf="isCreatingNew"></mat-spinner>
            <mat-icon *ngIf="!isCreatingNew">save</mat-icon>
            {{ isCreatingNew ? 'Création...' : 'Créer et Ajouter' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Liste des propriétaires -->
  <mat-card class="proprietaires-list-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>list</mat-icon>
        Propriétaires de la Parcelle
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div *ngIf="!hasProprietaires" class="no-proprietaires">
        <mat-icon color="disabled">group_off</mat-icon>
        <p>Aucun propriétaire défini</p>
        <p class="hint">Recherchez et ajoutez des propriétaires existants ou créez-en de nouveaux</p>
      </div>

      <!-- Vue liste -->
      <div *ngIf="hasProprietaires && viewMode === 'list'" class="list-view">
        <table mat-table [dataSource]="proprietaires" class="proprietaires-table">
          
          <!-- Colonne Propriétaire -->
          <ng-container matColumnDef="proprietaire">
            <th mat-header-cell *matHeaderCellDef>Propriétaire</th>
            <td mat-cell *matCellDef="let element">
              <div class="proprietaire-cell">
                <mat-icon [color]="element.proprietaire?.nature === 'Physique' ? 'primary' : 'accent'">
                  {{ getProprietaireIcon(element.proprietaire?.nature || 'Physique') }}
                </mat-icon>
                <div class="info">
                  <div class="name">
                    {{ element.proprietaire?.nom }} {{ element.proprietaire?.prenom || '' }}
                  </div>
                  <div class="cin">{{ element.proprietaire?.cin_ou_rc }}</div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Colonne Nature -->
          <ng-container matColumnDef="nature">
            <th mat-header-cell *matHeaderCellDef>Nature</th>
            <td mat-cell *matCellDef="let element">
              <mat-chip [color]="element.proprietaire?.nature === 'Physique' ? 'primary' : 'accent'">
                {{ getProprietaireTypeLabel(element.proprietaire?.nature || 'Physique') }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Colonne Contact -->
          <ng-container matColumnDef="contact">
            <th mat-header-cell *matHeaderCellDef>Contact</th>
            <td mat-cell *matCellDef="let element">
              <div class="contact-cell">
                <div *ngIf="element.proprietaire?.telephone" class="contact-item">
                  <mat-icon>phone</mat-icon>
                  <span>{{ element.proprietaire.telephone }}</span>
                </div>
                <div *ngIf="element.proprietaire?.email" class="contact-item">
                  <mat-icon>email</mat-icon>
                  <span>{{ element.proprietaire.email }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Colonne Quote-part -->
          <ng-container matColumnDef="quotePart">
            <th mat-header-cell *matHeaderCellDef>Quote-part</th>
            <td mat-cell *matCellDef="let element">
              <div class="quote-part-cell">
                <strong>{{ formatQuotePart(element.quote_part) }}</strong>
                <div class="amount" *ngIf="element.montant_individuel > 0">
                  {{ element.montant_individuel | currency:'MAD':'symbol':'1.2-2':'fr' }}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Colonne Statut -->
          <ng-container matColumnDef="statut">
            <th mat-header-cell *matHeaderCellDef>Statut</th>
            <td mat-cell *matCellDef="let element">
              <mat-chip [color]="getStatusColor(element.est_actif)">
                <mat-icon matChipAvatar>{{ getStatusIcon(element.est_actif) }}</mat-icon>
                {{ element.est_actif ? 'Actif' : 'Inactif' }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Colonne Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let element">
              <div class="actions-cell">
                <button mat-icon-button [matMenuTriggerFor]="actionsMenu" 
                       [disabled]="readonly">
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #actionsMenu="matMenu">
                  <button mat-menu-item (click)="editProprietaire(element)">
                    <mat-icon>edit</mat-icon>
                    <span>Modifier</span>
                  </button>

                  <button mat-menu-item (click)="toggleProprietaireStatus(element)">
                    <mat-icon>{{ element.est_actif ? 'toggle_off' : 'toggle_on' }}</mat-icon>
                    <span>{{ element.est_actif ? 'Désactiver' : 'Activer' }}</span>
                  </button>

                  <mat-divider></mat-divider>

                  <button mat-menu-item (click)="removeProprietaire(element)" 
                         class="delete-action">
                    <mat-icon>delete</mat-icon>
                    <span>Supprimer</span>
                  </button>
                </mat-menu>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
              [class.inactive-row]="!row.est_actif"></tr>
        </table>
      </div>

      <!-- Vue cartes -->
      <div *ngIf="hasProprietaires && viewMode === 'cards'" class="cards-view">
        <div class="cards-grid">
          <mat-card *ngFor="let proprietaire of proprietaires" class="proprietaire-card" 
                   [class.inactive-card]="!proprietaire.est_actif">
            <mat-card-header>
              <mat-icon mat-card-avatar [color]="proprietaire.proprietaire?.nature === 'Physique' ? 'primary' : 'accent'">
                {{ getProprietaireIcon(proprietaire.proprietaire?.nature || 'Physique') }}
              </mat-icon>
              <mat-card-title>
                {{ proprietaire.proprietaire?.nom }} {{ proprietaire.proprietaire?.prenom || '' }}
              </mat-card-title>
              <mat-card-subtitle>
                {{ getProprietaireTypeLabel(proprietaire.proprietaire?.nature || 'Physique') }}
              </mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <div class="card-info">
                <div class="info-item">
                  <mat-icon>badge</mat-icon>
                  <span>{{ proprietaire.proprietaire?.cin_ou_rc }}</span>
                </div>
                <div class="info-item" *ngIf="proprietaire.proprietaire?.telephone">
                  <mat-icon>phone</mat-icon>
                  <span>{{ proprietaire.proprietaire?.telephone }}</span>
                </div>
                <div class="info-item" *ngIf="proprietaire.proprietaire?.email">
                  <mat-icon>email</mat-icon>
                  <span>{{ proprietaire.proprietaire?.email }}</span>
                </div>
                <div class="info-item quote-part">
                  <mat-icon>pie_chart</mat-icon>
                  <span>Quote-part: <strong>{{ formatQuotePart(proprietaire.quote_part) }}</strong></span>
                </div>
              </div>
            </mat-card-content>

            <mat-card-actions>
              <button mat-button (click)="editProprietaire(proprietaire)" [disabled]="readonly">
                <mat-icon>edit</mat-icon>
                Modifier
              </button>
              
              <button mat-button (click)="toggleProprietaireStatus(proprietaire)" [disabled]="readonly">
                <mat-icon>{{ proprietaire.est_actif ? 'toggle_off' : 'toggle_on' }}</mat-icon>
                {{ proprietaire.est_actif ? 'Désactiver' : 'Activer' }}
              </button>

              <button mat-button color="warn" (click)="removeProprietaire(proprietaire)" 
                     [disabled]="readonly">
                <mat-icon>delete</mat-icon>
                Supprimer
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>

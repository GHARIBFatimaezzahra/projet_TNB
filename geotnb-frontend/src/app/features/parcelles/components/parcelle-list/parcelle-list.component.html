<!-- ===================================================== -->
<!-- HEADER PRINCIPAL -->
<!-- ===================================================== -->
<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2>Liste des Parcelles TNB</h2>
    <div style="display: flex; gap: 1rem;">
      <button class="btn btn-secondary" (click)="goBack()">
        <i class="fas fa-arrow-left"></i> Retour
      </button>
      <button class="btn btn-info" (click)="viewMap()">
        <i class="fas fa-map"></i> Vue carte
      </button>
      <button class="btn btn-primary" routerLink="/parcelles/new">
        <i class="fas fa-plus"></i> Nouvelle parcelle
    </button>
              <button class="btn btn-secondary" (click)="refreshData()" [disabled]="loading">
          <i class="fas fa-sync-alt" [class.fa-spin]="loading"></i> Actualiser
    </button>
        <button class="btn btn-info" (click)="testAPI()" [disabled]="loading">
          <i class="fas fa-bug"></i> Test API
    </button>
  </div>
</div>

  <!-- ===================================================== -->
  <!-- STATISTIQUES EN TEMPS RÉEL -->
  <!-- ===================================================== -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-icon" style="background: rgba(30, 64, 175, 0.1); color: var(--primary-color);">
          <i class="fas fa-bars"></i>
        </div>
        <div class="stat-info">
          <h3>{{ statistics?.total || 0 | number }}</h3>
          <p>Parcelles totales</p>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-icon" style="background: rgba(5, 150, 105, 0.1); color: var(--success-color);">
          <i class="fas fa-check"></i>
        </div>
        <div class="stat-info">
          <h3>{{ statistics?.publiees || 0 | number }}</h3>
          <p>Publiées</p>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-icon" style="background: rgba(217, 119, 6, 0.1); color: var(--warning-color);">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-info">
          <h3>{{ statistics?.enValidation || 0 | number }}</h3>
          <p>En validation</p>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-icon" style="background: rgba(100, 116, 139, 0.1); color: var(--gray-500);">
          <i class="fas fa-pencil-alt"></i>
        </div>
        <div class="stat-info">
          <h3>{{ statistics?.brouillons || 0 | number }}</h3>
          <p>Brouillons</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================================================== -->
  <!-- FILTRES ET RECHERCHE AVANCÉE -->
  <!-- ===================================================== -->
  <div class="filters-panel">
    <div class="filters-row">
      <div class="filter-group">
        <label class="form-label">Recherche globale</label>
        <input type="text" 
               class="form-control" 
               [(ngModel)]="searchTerm"
               (keyup)="onSearch()"
               placeholder="Référence, propriétaire, zone, statut foncier, occupation, quote-part...">
      </div>

      <div class="filter-group">
        <label class="form-label">Zone</label>
        <select class="form-control" [(ngModel)]="selectedZone" (change)="onZoneChange()">
          <option value="">Toutes les zones</option>
          <option value="R1">R1 - Résidentiel dense</option>
          <option value="R2">R2 - Résidentiel moyen</option>
          <option value="R3">R3 - Résidentiel faible</option>
          <option value="R4">R4 - Résidentiel très faible</option>
          <option value="I">I - Industriel</option>
          <option value="C">C - Commercial</option>
          <option value="COM">COM - Commercial</option>
          <option value="IND">IND - Industriel</option>
        </select>
    </div>

      <div class="filter-group">
        <label class="form-label">Statut</label>
        <select class="form-control" [(ngModel)]="selectedStatus" (change)="onStatusChange()">
          <option value="">Tous les statuts</option>
          <option value="Brouillon">Brouillon</option>
          <option value="Valide">Validé</option>
          <option value="Publie">Publié</option>
          <option value="Archive">Archivé</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="form-label">Type foncier</label>
        <select class="form-control" [(ngModel)]="selectedStatutFoncier" (change)="onStatutFoncierChange()">
          <option value="">Tous</option>
          <option value="TF">TF - Titre foncier</option>
          <option value="R">R - Réquisition</option>
          <option value="NI">NI - Non immatriculé</option>
          <option value="Domanial">Domanial</option>
          <option value="Collectif">Collectif</option>
        </select>
    </div>

      <div class="filter-group">
        <label class="form-label" style="opacity: 0;">Action</label>
        <button class="btn btn-primary" (click)="applyFilters()" style="width: 100%;">
          <i class="fas fa-filter"></i> Filtrer
      </button>
    </div>
    </div>
</div>

  <!-- ===================================================== -->
  <!-- ACTIONS EN LOT -->
  <!-- ===================================================== -->
  <div class="card">
    <div class="card-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <span>{{ selection.selected.length }} parcelle(s) sélectionnée(s)</span>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-warning btn-sm" 
                  [disabled]="selection.selected.length === 0"
                  (click)="validateSelected()">
            <i class="fas fa-check"></i> Valider en lot
          </button>
          <button class="btn btn-success btn-sm" 
                  [disabled]="selection.selected.length === 0"
                  (click)="publishSelected()">
            <i class="fas fa-arrow-up"></i> Publier en lot
          </button>
          <button class="btn btn-info btn-sm" 
                  [disabled]="selection.selected.length === 0"
                  (click)="exportSelected()">
            <i class="fas fa-arrow-down"></i> Exporter sélection
          </button>
          <button class="btn btn-danger btn-sm" 
                  [disabled]="selection.selected.length === 0"
                  (click)="deleteSelected()">
            <i class="fas fa-trash"></i> Supprimer en lot
      </button>
        </div>
      </div>
    </div>
    </div>

  <!-- ===================================================== -->
  <!-- TABLE PRINCIPALE -->
  <!-- ===================================================== -->
  <div class="card">
    <div class="card-body" style="padding: 0;">
    <div class="table-container">
        <table mat-table [dataSource]="dataSource" class="table" matSort (matSortChange)="onSortChange($event)">
        
          <!-- Colonne de sélection -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox (change)="toggleAllSelection($event.checked)"
                          [checked]="isAllSelected()"
                          [indeterminate]="isPartialSelection()">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let parcelle">
              <mat-checkbox (change)="toggleSelection(parcelle, $event.checked)"
                          [checked]="isSelected(parcelle)">
            </mat-checkbox>
          </td>
        </ng-container>

          <!-- Référence -->
          <ng-container matColumnDef="reference">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Référence
              <i class="fas fa-sort" style="margin-left: 0.5rem; cursor: pointer;"></i>
            </th>
          <td mat-cell *matCellDef="let parcelle">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-circle" [ngClass]="getStatusIconClass(parcelle.etatValidation)"></i>
                <span class="reference-text">
                  {{ parcelle.referenceFonciere }}
            </span>
              </div>
          </td>
        </ng-container>

          <!-- Zone -->
          <ng-container matColumnDef="zone">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Zone
              <i class="fas fa-sort" style="margin-left: 0.5rem; cursor: pointer;"></i>
            </th>
          <td mat-cell *matCellDef="let parcelle">
              <span class="badge badge-secondary">{{ parcelle.zonage }}</span>
          </td>
        </ng-container>

          <!-- Surface -->
          <ng-container matColumnDef="surface">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Surface (m²)
              <i class="fas fa-sort" style="margin-left: 0.5rem; cursor: pointer;"></i>
            </th>
          <td mat-cell *matCellDef="let parcelle">
              <div>
                <strong>{{ parcelle.surfaceTotale | number }}</strong><br>
                <small style="color: var(--gray-500);">{{ parcelle.surfaceImposable | number }} imposable</small>
              </div>
          </td>
        </ng-container>

        <!-- Propriétaires -->
        <ng-container matColumnDef="proprietaires">
            <th mat-header-cell *matHeaderCellDef>
              Propriétaires
            </th>
          <td mat-cell *matCellDef="let parcelle">
              <div *ngIf="parcelle.proprietaires && parcelle.proprietaires.length > 0">
                <div *ngFor="let prop of parcelle.proprietaires.slice(0, 2); let i = index">
                  <span *ngIf="i === 0">
                    {{ prop.proprietaire?.nomComplet || prop.proprietaire?.nom || 'Propriétaire inconnu' }} 
                    ({{ (prop.quotePart * 100) | number:'1.0-1' }}%)
                  </span>
                  <small *ngIf="i === 1" style="color: var(--gray-500);">
                    {{ prop.proprietaire?.nomComplet || prop.proprietaire?.nom || 'Propriétaire inconnu' }} 
                    ({{ (prop.quotePart * 100) | number:'1.0-1' }}%)
                  </small>
                </div>
                <small *ngIf="parcelle.proprietaires.length > 2" style="color: var(--gray-500);">
                  +{{ parcelle.proprietaires.length - 2 }} autre(s)
                </small>
              </div>
              <div *ngIf="!parcelle.proprietaires || parcelle.proprietaires.length === 0">
                <span style="color: var(--gray-500);">Aucun propriétaire</span>
            </div>
          </td>
        </ng-container>

          <!-- TNB -->
          <ng-container matColumnDef="tnb">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              TNB (DH)
              <i class="fas fa-sort" style="margin-left: 0.5rem; cursor: pointer;"></i>
            </th>
          <td mat-cell *matCellDef="let parcelle">
              <strong style="color: var(--success-color);">{{ parcelle.montantTotalTnb | number:'1.0-0' }}</strong>
          </td>
        </ng-container>

          <!-- Statut -->
          <ng-container matColumnDef="statut">
            <th mat-header-cell *matHeaderCellDef>
              Statut
            </th>
          <td mat-cell *matCellDef="let parcelle">
              <span class="badge" [ngClass]="getStatusClass(parcelle.etatValidation)">
                {{ getStatusLabel(parcelle.etatValidation) }}
              </span>
          </td>
        </ng-container>

          <!-- Dernière MAJ -->
          <ng-container matColumnDef="derniere_maj">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Dernière MAJ
              <i class="fas fa-sort" style="margin-left: 0.5rem; cursor: pointer;"></i>
            </th>
          <td mat-cell *matCellDef="let parcelle">
              <div>
                {{ parcelle.dateModification | date:'dd/MM/yyyy' }}<br>
                <small style="color: var(--gray-500);">par admin</small>
              </div>
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>
              Actions
            </th>
            <td mat-cell *matCellDef="let parcelle">
              <div style="display: flex; gap: 0.25rem;">
                <button class="btn btn-secondary btn-sm" 
                        (click)="viewParcelle(parcelle)" 
                        title="Voir détails">
                  <i class="fas fa-eye"></i>
            </button>
                <button class="btn btn-primary btn-sm" 
                        (click)="editParcelle(parcelle)"
                        title="Modifier">
                  <i class="fas fa-pencil-alt"></i>
            </button>
                <button class="btn btn-info btn-sm" 
                        [disabled]="!parcelle.geometrie"
                        (click)="locateParcelle(parcelle)"
                        [title]="parcelle.geometrie ? 'Localiser' : 'Pas de géométrie'">
                  <i class="fas fa-map-marker-alt"></i>
            </button>
                <button class="btn btn-secondary btn-sm" 
                        (click)="generatePDF(parcelle)"
                        title="Fiche PDF">
                  <i class="fas fa-file-pdf"></i>
            </button>
                <button class="btn btn-secondary btn-sm" 
                        (click)="viewHistory(parcelle)"
                        title="Historique">
                  <i class="fas fa-history"></i>
                </button>
                <button class="btn btn-secondary btn-sm" 
                        (click)="duplicateParcelle(parcelle)"
                        title="Dupliquer">
                  <i class="fas fa-copy"></i>
              </button>
                <button class="btn btn-warning btn-sm" 
                        *ngIf="parcelle.etatValidation === 'Brouillon'"
                        (click)="validateParcelle(parcelle)"
                        title="Valider">
                  <i class="fas fa-check"></i>
              </button>
                <button class="btn btn-danger btn-sm" 
                        (click)="deleteParcelle(parcelle)"
                        title="Supprimer">
                  <i class="fas fa-trash"></i>
              </button>
              </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
      </div>
    </div>

    <!-- Pagination -->
    <div class="card-footer">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="color: var(--gray-600);">
          Affichage de {{ getDisplayRange() }} sur {{ totalParcelles | number }} parcelles
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-secondary btn-sm" 
                  [disabled]="currentPage === 0"
                  (click)="previousPage()">
            <i class="fas fa-chevron-left"></i> Précédent
          </button>
          <button class="btn btn-primary btn-sm" 
                  *ngFor="let page of getPageNumbers()"
                  [class.btn-primary]="page === currentPage + 1"
                  [class.btn-secondary]="page !== currentPage + 1"
                  (click)="goToPage(page - 1)">
            {{ page }}
          </button>
          <button class="btn btn-secondary btn-sm" 
                  [disabled]="currentPage >= totalPages - 1"
                  (click)="nextPage()">
            Suivant <i class="fas fa-chevron-right"></i>
          </button>
        </div>
  </div>
  </div>
  </div>
</div>

<!-- Loading spinner -->
<div *ngIf="loading" class="loading-overlay">
  <mat-spinner></mat-spinner>
</div>

<!-- Error message -->
<div *ngIf="error" class="error-message">
  <i class="fas fa-exclamation-triangle"></i>
  {{ error }}
</div>